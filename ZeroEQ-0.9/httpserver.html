<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>ZeroEQ: HTTP Server for ZeroEq Events</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ZeroEQ
   &#160;<span id="projectnumber">0.9.0</span>
   </div>
   <div id="projectbrief">ZeroEQ - Zero Event Queue</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('httpserver.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">HTTP Server for ZeroEq Events </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The <a href="http::Server">http::Server</a> implements a <a class="el" href="classzeroeq_1_1_receiver.html" title="Base class for entities receiving data. ">zeroeq::Receiver</a> and Sender to serve ZeroBuf objects through a REST interface with JSON payload. It is the evolution of the RESTBridge. <a href="https://github.com/HBPVIS/ZeroEQ/issues/115">Issue 115</a> tracks the implementation.</p>
<h2>Requirements</h2>
<ul>
<li>Translate Zerobufs to and from JSON</li>
<li>Accept PUT requests to update subscribed Zerobuf in the same way as a <a class="el" href="classzeroeq_1_1_subscriber.html" title="Subscribes to Publisher to receive events. ">zeroeq::Subscriber</a></li>
<li>Accept GET requests and reply with the current state of registered Zerobuf in the same way as a Publisher::publish().</li>
<li>Allow custom code execution while handling a GET request, e.g., to render a new frame before serving a ImageJPEG request</li>
<li>Implement the same client REST API as the current RESTBridge</li>
<li>Do not accept POST requests (as RestBridge does for updates): They are for adding objects, which we might introduce later.</li>
</ul>
<h2>Dependency Changes</h2>
<ul>
<li>Remove: RESTBridge, cppnetlib</li>
<li>Add: httpxx http parsing library, will be subproject, replaces cppnetlib</li>
</ul>
<h2>API</h2>
<pre class="fragment">namespace servus
{
/** Interface for serializable objects */
class Serializable
{
public:
    struct Data
    {
        std::shared_ptr&lt; void* &gt; ptr;
        size_t size;
    };

    virtual uint128_t getTypeIdentifier() const = 0;

    virtual void fromBinary( const void* data, const size_t size );
    virtual Data toBinary() const;

    virtual void fromJSON( const std::string&amp; json );
    virtual std::string toJSON() const;

    /**
     * Register a function called after the object has been updated remotely
     * (via a subscriber, a http server, loading from file...).
     * Only one callback is supported at the moment, to deregister the callback,
     * call this function with a 'nullptr' (or 0) parameter.
     *
     * @throw if a DeserializedCallback is already registered and the specified
     * callback is not 'nullptr' (or 0)
     */
    SERVUS_API void registerDeserializedCallback( const DeserializedCallback&amp; );

    /**
     * Register a function to be called when the serializable object is about
     * to be serialized.
     * Only one callback is supported at the moment, to deregister the callback,
     * call this function with a 'nullptr' (or 0) parameter.
     *
     * @throw if a SerializedCallback is already registered and the specified
     * callback is not 'nullptr' (or 0)
     */
    SERVUS_API void registerSerializeCallback( const SerializeCallback&amp; );
};
}

namespace zeroeq
{
namespace http
{
class Server : public zeroeq::Receiver
{
public:
    // throws if scheme is not empty or tcp
    explicit Server( const URI&amp; uri );
    Server( const URI&amp; uri, Receiver&amp; shared );

    /**
     * Create a new Server when requested.
     *
     * The creation and parameters depend on the following command line
     * parameters:
     * * --zeroeq-http-server [host][:port]: Enable the server. Optional
     *   parameters configure the web server, running by default on :4020
     */
    static std::unique_ptr&lt; Server &gt; parse( argc, argv );
    static std::unique_ptr&lt; Server &gt; parse( argc, argv, Receiver&amp; shared );

    bool handle( servus::Serializable&amp; object );
    bool remove( const servus::Serializable&amp; object );

    bool handlePUT( servus::Serializable&amp; object );
    bool removePUT( const servus::Serializable&amp; object );

    bool handleGET( servus::Serializable&amp; object );
    bool removeGET( const servus::Serializable&amp; object );

    // + 8 overloads with PUTFunc, PUTPayloadFunc, GETFunc
};
}
}
</pre><h2>Examples</h2>
<pre class="fragment">void livre::Communicator::_setupRESTBridge( const int argc, char** argv )
{
    _httpServer = zeroeq::http::Server::parse( argc, argv );
    if( !_httpServer )
        return;

    subscribers.push_back( _httpServer );
    _httpServer.handle( camera, LUT, vrParams );
    _httpServer.handleGET( frame );
}

class livre::ImageJPEG : public zeroeq::hbp::ImageJPEG
{
protected:
    void notifyRequested() final
    {
        config-&gt;frame(); // redraw before serving the last image
    }
</pre><p> };</p>
<h2>Implementation</h2>
<ul>
<li>Hooked into ZeroEQ as a stream zmq socket: <a href="http://api.zeromq.org/4-1:zmq-socket#toc22">http://api.zeromq.org/4-1:zmq-socket#toc22</a></li>
<li>Implemented as a shared receiver, that is, can be grouped with other subscribers and servers for a single receive()</li>
<li>Processes data using a HTTP parsing library (see Issue 2)</li>
<li>Remove generic Schema-based JSON conversion<ul>
<li>Generate to/fromJSON in code generator</li>
<li>Remove Schema and JsonConverter</li>
</ul>
</li>
</ul>
<h3>Server pseudo-code</h3>
<p>void http::Server::process( zeroeq::detail::Socket&amp; socket ) { zmq_recv, feed to message if message is complete for PUT: _subscribed[ type ].fromJSON( message.body( )) _subscribed[ type ].notifyUpdated() zmq_send( 200/404 ) for GET: _registered[ type ].notifyRequested() zmq_send( 200 + _registered[ type ].toJSON( ))</p>
<p>}</p>
<h2>Issues</h2>
<h3>1: Shall we remove the generic JSON conversion?</h3>
<p>Resolved: Yes, when maintenance becomes a burden.</p>
<p>Removing the generic conversion and emiting specific code in the generator simplifies the implementation significantly. It does however remove the capability to translate to and from JSON in an indepent component which does not have access to the application-specific vocabulary. Today this is only used when the REST bridge is run as a separate process.</p>
<p>To not impose Zerobuf on other applications (e.g. for the visualization web services), the servus::Serializable interface defines the minimal API used by the <a class="el" href="classzeroeq_1_1_subscriber.html" title="Subscribes to Publisher to receive events. ">zeroeq::Subscriber</a> and <a class="el" href="classzeroeq_1_1http_1_1_server.html" title="Serves HTTP GET and PUT requests for servus::Serializable objects. ">zeroeq::http::Server</a>, to be implemented by applications (and ZeroBuf).</p>
<h3>2: How do we parse HTTP?</h3>
<p>Resolved: Use httpxx. Fix CMake as needed to integrate as a sub project.</p>
<p>Candidates:</p><ul>
<li>Write code: reject, NIH.</li>
<li>libghttp: Hard to find repository, C code, seems to live in Gnome TCP socket now</li>
<li><a href="https://github.com/AndreLouisCaron/httpxx">https://github.com/AndreLouisCaron/httpxx</a><ul>
<li>cmake, builds on Ubuntu, no install rules, not sub-project ready, small</li>
<li>Example: <a href="https://github.com/AndreLouisCaron/httpxx/blob/master/demo/parse-in-random-increments.cpp">https://github.com/AndreLouisCaron/httpxx/blob/master/demo/parse-in-random-increments.cpp</a></li>
</ul>
</li>
<li>All other candidates where a full http server<ul>
<li>Mongrel2: A full-blown, programmable, scalable web server with its own network code (ie. not ZeroMQ-glueable)</li>
<li>zurl: A simple web server using ZeroMQ and Qt, large dependencies for the feature set</li>
</ul>
</li>
</ul>
<h3>3: What about SSL/TLS?</h3>
<p>Resolved: Delay, later either use proxy http servers or do a native integration.</p>
<p>The native ZeroEQ integration using a zmq socket enables seamless application integration. For an application, a <a href="http::Server">http::Server</a> behaves as a Subscriber, and they can be integrated in a shared receiver group. Unfortunately there is little prior work on SSL/TLS over zmq stream sockets. The easiest seems to be using a proxy frontend server to shield the (anyways unprotected) applications. The more involved seems to be integrate OpenSSL (or similar) with zmq:</p>
<ul>
<li><a href="http://www.riskcompletefailure.com/2012/09/tls-and-zeromq.html">http://www.riskcompletefailure.com/2012/09/tls-and-zeromq.html</a></li>
<li><a href="https://github.com/ianbarber/TLSZMQ">https://github.com/ianbarber/TLSZMQ</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="rfcs.html">RFCs</a></li>
    <li class="footer">Generated on Sat Aug 19 2017 01:36:48 for ZeroEQ by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
